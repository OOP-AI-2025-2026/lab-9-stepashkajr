name: Checking lab work

on: [push, pull_request]

permissions:
  checks: write
  contents: read
  actions: read

jobs:
  build:
    name: Compile + Tests + Static Analysis + ChatGPT
    runs-on: ubuntu-latest

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      CHATGPT_MODEL: gpt-5-nano
      CHATGPT_PROMPT: >
        Проаналізуй наступний код студента мовою Java.
        Перевір коректність виконання завдання: чи відповідає код умові, чи немає логічних помилок, чи працює програма для різних вхідних даних.
        Перевір оформлення коду.
        Склади звіт у двох розділах:
        Коректність коду — перерахуй знайдені помилки або вкажи, що код працює правильно.
        Стиль коду — перерахуй порушення стилю, запропонуй поліпшення.
        Напиши тільки відповідь. Не пиши рекомендації щодо завдання.
        Оціни роботу за 100-бальною системою.

    steps:

      # Checkout
      - uses: actions/checkout@v4

      # Java 17
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      # 1) Compile
      - name: Compile
        working-directory: ./app
        run: mvn -B -ntp -DskipTests=true clean package

      # 2) Run Unit Tests (FAIL if tests fail)
      - name: Run Unit Tests
        working-directory: ./app
        run: mvn -B -ntp test

      # 3) Checkstyle (soft)
      - name: Run Checkstyle
        working-directory: ./app
        run: mvn -B -ntp checkstyle:checkstyle || echo "⚠️ Checkstyle violations ignored"

      # 4) PMD (soft)
      - name: Run PMD
        working-directory: ./app
        run: mvn -B -ntp pmd:check || echo "⚠️ PMD violations ignored"

      # 5) SpotBugs (soft)
      - name: Run SpotBugs
        working-directory: ./app
        run: mvn -B -ntp com.github.spotbugs:spotbugs-maven-plugin:check || echo "⚠️ SpotBugs issues ignored"

      # 6) Spotless (soft)
      - name: Spotless check
        working-directory: ./app
        run: mvn -B -ntp spotless:check || echo "⚠️ Spotless formatting issues ignored"

      # 7) Collect Java files
      - name: Collect Java files
        id: collect
        run: |
          mkdir -p chatgpt
          git ls-files | grep -E 'app/src/.*/ua/opnu/.*\.java$' > java_files_for_review.txt || true
          COUNT=$(wc -l < java_files_for_review.txt | xargs)
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          if [ "$COUNT" -gt 0 ]; then
            echo "has_files=true" >> $GITHUB_OUTPUT
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
          fi

      # 8) ChatGPT review
      - name: ChatGPT code review
        if: ${{ steps.collect.outputs.has_files == 'true' }}
        run: |
          python3 -m pip install --upgrade pip requests

          cat > gpt_review.py << 'PY'
          import os, json, pathlib, requests
          api_key = os.environ.get("OPENAI_API_KEY")
          model = os.environ.get("CHATGPT_MODEL","gpt-5-nano")
          system_instructions = os.environ.get("CHATGPT_PROMPT")

          files = [p.strip() for p in open("java_files_for_review.txt").read().splitlines() if p.strip()]
          text = ""
          for fp in files:
              with open(fp,"r",encoding="utf-8",errors="ignore") as f:
                  text += f"\n\n### FILE: {fp}\n```java\n{f.read()}\n```"

          if api_key:
              headers = {"Authorization": f"Bearer {api_key}", "Content-Type": "application/json"}
              body = {"model": model, "input": text, "instructions": system_instructions}
              r = requests.post("https://api.openai.com/v1/responses", headers=headers, data=json.dumps(body))

              out = "_(No textual content parsed from response)_"
              if r.status_code == 200:
                  data = r.json()
                  out = data.get("output_text") or "\n".join(
                      c["text"] for item in data.get("output", []) for c in item.get("content", []) if "text" in c
                  )
              else:
                  out = f"API error {r.status_code}: {r.text[:400]}"

              pathlib.Path("chatgpt/chatgpt_report.md").write_text(out, encoding="utf-8")
          else:
              pathlib.Path("chatgpt/chatgpt_report.md").write_text("_Not generated (no key)_", encoding="utf-8")
          PY

          python3 gpt_review.py

      # 9) Ensure report exists
      - name: Ensure ChatGPT report exists
        if: always()
        run: |
          if [ ! -f chatgpt/chatgpt_report.md ]; then
            mkdir -p chatgpt
            echo "# ChatGPT Review Report" > chatgpt/chatgpt_report.md
            echo "" >> chatgpt/chatgpt_report.md
            echo "_Not generated._" >> chatgpt/chatgpt_report.md
          fi

      # 10) Archive reports
      - name: Archive Reports
        uses: actions/upload-artifact@v4
        with:
          name: reports
          path: |
            chatgpt/chatgpt_report.md
            app/target/checkstyle-result.xml
            app/target/site/checkstyle.html
            app/target/site/pmd.html
            app/target/spotbugsXml.xml
          if-no-files-found: warn
